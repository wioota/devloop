#!/bin/bash
#
# Stop hook: Collect DevLoop findings when Claude finishes responding
#
# This automatically runs verification after Claude's work, similar to
# Amp's post-task hook, but non-blocking to not interfere with user review.
#
# Runs when Claude Code finishes responding. Non-blocking: doesn't interfere
# with Claude's output or user interaction.

set -e

PROJECT_DIR="${CLAUDE_PROJECT_DIR:-.}"
cd "$PROJECT_DIR" || exit 0

# Check if devloop is available
if ! command -v devloop &>/dev/null; then
    exit 0
fi

# Check if this is a resumption from previous stop hook
# (prevent infinite loops)
input_json=$(cat)
stop_hook_active=$(echo "$input_json" | jq -r '.stop_hook_active // false' 2>/dev/null || echo "false")

if [ "$stop_hook_active" = "true" ]; then
    # Already running in a stop hook continuation, don't re-run
    exit 0
fi

# Collect findings silently (non-blocking)
devloop amp_findings 2>/dev/null || true

exit 0
