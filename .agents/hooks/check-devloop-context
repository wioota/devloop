#!/bin/bash
#
# PreToolUse hook: Check for unreviewed DevLoop findings before file operations
#
# Fast (<100ms) hook that warns Claude about agent findings before file ops.
# Includes debouncing (warns at most once per 30 seconds) to avoid spam.
#
# Exit codes:
#   0 - No findings or recently warned (allow operation)
#   Non-zero would block but we always exit 0 to not block operations

PROJECT_DIR="${CLAUDE_PROJECT_DIR:-.}"
cd "$PROJECT_DIR" || exit 0

# Debounce settings
DEBOUNCE_SECONDS=30
DEBOUNCE_FILE="/tmp/devloop-context-warned-$$"

# Check if we've warned recently (within DEBOUNCE_SECONDS)
# Use parent PID for consistent debouncing across Claude session
DEBOUNCE_FILE="/tmp/devloop-context-warned-${PPID:-$$}"
if [[ -f "$DEBOUNCE_FILE" ]]; then
    LAST_WARN=$(cat "$DEBOUNCE_FILE" 2>/dev/null || echo "0")
    NOW=$(date +%s)
    ELAPSED=$((NOW - LAST_WARN))
    if [[ $ELAPSED -lt $DEBOUNCE_SECONDS ]]; then
        # Already warned recently, skip
        exit 0
    fi
fi

# Read hook input (we don't need it but must consume stdin)
cat > /dev/null

# Fast check: Does context file exist?
CONTEXT_INDEX="$PROJECT_DIR/.devloop/context/index.json"
if [[ ! -f "$CONTEXT_INDEX" ]]; then
    # No context file, nothing to check
    exit 0
fi

# Fast check: Is the context stale? (>30 min old means devloop watch not running)
if [[ "$OSTYPE" == "darwin"* ]]; then
    LAST_UPDATED=$(stat -f %m "$CONTEXT_INDEX" 2>/dev/null || echo "0")
else
    LAST_UPDATED=$(stat -c %Y "$CONTEXT_INDEX" 2>/dev/null || echo "0")
fi
NOW=$(date +%s)
AGE_SECONDS=$((NOW - LAST_UPDATED))
if [[ $AGE_SECONDS -gt 1800 ]]; then
    # Context is stale (>30 min), devloop watch likely not running
    # Don't warn every time, just exit
    exit 0
fi

# Quick grep for check_now count (faster than full JSON parse)
CHECK_NOW_COUNT=$(grep -o '"check_now"[^}]*"count": [0-9]*' "$CONTEXT_INDEX" 2>/dev/null | grep -o '[0-9]*$' || echo "0")

if [[ "$CHECK_NOW_COUNT" -gt 0 ]]; then
    # Record warning time for debounce
    date +%s > "$DEBOUNCE_FILE"

    # Output warning to stderr (visible to Claude)
    cat >&2 <<EOF
DevLoop: $CHECK_NOW_COUNT agent finding(s) need attention.
Run /agent-summary for details before continuing.
EOF
fi

exit 0
