#!/bin/bash
#
# PreToolUse hook: Block modifications to protected files
#
PROJECT_DIR="${CLAUDE_PROJECT_DIR:-.}"
cd "$PROJECT_DIR" || exit 0
input_json=$(cat)
tool_name=$(echo "$input_json" | jq -r '.tool_name // ""' 2>/dev/null || echo "")
tool_input=$(echo "$input_json" | jq -r '.tool_input // {}' 2>/dev/null || echo "{}")
if [[ "$tool_name" != "Write" && "$tool_name" != "Edit" ]]; then
    exit 0
fi
file_path=$(echo "$tool_input" | jq -r '.path // ""' 2>/dev/null || echo "")
if [ -n "$file_path" ]; then
    file_path=$(realpath "$file_path" 2>/dev/null || echo "$file_path")
fi
protected_patterns=(".beads/" ".devloop/" ".git/" ".agents/hooks/" ".claude/" "AGENTS.md" "CODING_RULES.md" "AMP_ONBOARDING.md")
is_protected=0
for pattern in "${protected_patterns[@]}"; do
    if [[ "$file_path" == *"$pattern"* ]]; then
        is_protected=1
        break
    fi
done
if [ $is_protected -eq 1 ]; then
    cat >&2 <<EOF
ðŸš« Protected file: $file_path
This file is protected by DevLoop to prevent accidental modifications.
If you need to modify this file, use manual editing or ask the user.
EOF
    exit 2
fi
exit 0
