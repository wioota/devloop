#!/bin/bash
#
# PreToolUse hook: Block modifications to protected files
#
# Prevents accidental modifications to critical DevLoop and Git files
# that could corrupt state or break workflows.
#
# File protection can be customized via .claude/file-protection-whitelist.json

PROJECT_DIR="${CLAUDE_PROJECT_DIR:-.}"
cd "$PROJECT_DIR" || exit 0

# Write input to temp file since Python will read stdin
input_file=$(mktemp)
cat > "$input_file"

# Use Python to parse and check
python3 << EOF
import json
import sys
import os
from pathlib import Path

try:
    with open('$input_file') as f:
        input_data = f.read()
    
    if not input_data:
        sys.exit(0)
    
    hook_input = json.loads(input_data)
    tool_name = hook_input.get('tool_name', '')
    tool_input = hook_input.get('tool_input', {})
    file_path = tool_input.get('path', '') if isinstance(tool_input, dict) else ''
    
    # Only process Write/Edit tools
    if tool_name not in ['Write', 'Edit']:
        sys.exit(0)
    
    if not file_path:
        sys.exit(0)
    
    # Normalize path
    try:
        file_path = os.path.realpath(file_path)
    except:
        pass
    
    # Protected patterns (default)
    protected_patterns = [
        '.beads/',
        '.devloop/',
        '.git/',
        '.agents/hooks/',
        '.claude/',
        'AGENTS.md',
        'CODING_RULES.md',
        'AMP_ONBOARDING.md',
    ]
    
    # Load whitelist if it exists
    whitelist = []
    whitelist_file = Path('.claude/file-protection-whitelist.json')
    if whitelist_file.exists():
        try:
            with open(whitelist_file) as f:
                whitelist_data = json.load(f)
                whitelist = whitelist_data.get('allowed_patterns', [])
        except:
            pass
    
    # Check if file is whitelisted (allowed despite being protected)
    is_whitelisted = any(pattern in file_path for pattern in whitelist)
    if is_whitelisted:
        sys.exit(0)
    
    # Check if file matches protected pattern
    is_protected = any(pattern in file_path for pattern in protected_patterns)
    
    if is_protected:
        # Block the write
        error_msg = f"""ðŸš« Protected file: {file_path}

This file is protected by DevLoop to prevent accidental modifications.
If you need to modify this file:
1. Use manual editing via terminal: nano "{file_path}"
2. Or ask the user to make the change manually
3. Or describe what you're trying to do
4. To whitelist this file, add it to .claude/file-protection-whitelist.json
"""
        sys.stderr.write(error_msg)
        sys.exit(2)  # Exit code 2 = blocking error
    
    sys.exit(0)

except Exception as e:
    sys.exit(0)
EOF

EXIT_CODE=$?

# Clean up
rm -f "$input_file"

exit $EXIT_CODE
