#!/usr/bin/env bash

# Post-task verification hook
# Called by Amp/system after task completion to enforce commit discipline
# 
# This hook ensures:
# 1. All work is committed and pushed (via verify-task-complete)
# 2. Code quality checks pass (formatting, linting, types, tests)
# 3. DevLoop findings are extracted and filed as Beads issues

set -e

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
PROJECT_ROOT="$(dirname "$(dirname "$SCRIPT_DIR")")"

cd "$PROJECT_ROOT"

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "Post-Task Verification"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Step 1: Basic commit/push verification
if ! .agents/verify-task-complete; then
    echo ""
    echo "âš ï¸  Task verification failed. Please fix the issues above."
    echo ""
    echo "Quick fix steps:"
    echo "  1. git status              # See what needs to be done"
    echo "  2. git add <files>         # Stage changes"
    echo "  3. git commit -m '...'     # Commit with descriptive message"
    echo "  4. git push origin main    # Push changes"
    echo "  5. .agents/verify-task-complete  # Verify again"
    echo ""
    exit 1
fi

echo ""
echo "âœ… Commit & push verification passed"
echo ""

# Step 2: Run common code quality checks (non-blocking for Amp tasks)
# These are the same checks that run in git pre-commit, but we run them
# after task completion so developers can see any issues
SKIP_VERSION_CHECK=1 SKIP_LOCK_CHECK=1 .agents/verify-common-checks || {
    # Non-blocking - just warn about quality issues
    echo ""
    echo "âš ï¸  Some code quality checks failed (non-blocking in post-task)"
    echo "     Consider fixing these issues in your next task:"
    echo "     - Run 'poetry run black src/' for formatting"
    echo "     - Run 'poetry run ruff check src/ --fix' for linting"
    echo "     - Run 'poetry run mypy ...' for type checking"
    echo "     - Run 'poetry run pytest' for tests"
    echo ""
}

# Step 3: Extract DevLoop findings to Beads issues
echo ""
echo "[Findings] Extracting DevLoop findings..."

FINDINGS_SCRIPT=".agents/hooks/extract-findings-to-beads"
if [ -x "$FINDINGS_SCRIPT" ]; then
    if "$FINDINGS_SCRIPT"; then
        echo "[Findings] âœ… DevLoop findings processed"
    else
        echo "[Findings] âš ï¸  Could not process DevLoop findings (non-blocking)"
    fi
else
    echo "[Findings] ğŸ“ Extract-findings script not found (optional)"
fi

echo ""
echo "âœ¨ Task verification complete. Ready for next task."
echo ""
exit 0
