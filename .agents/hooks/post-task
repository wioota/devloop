#!/usr/bin/env bash

# Post-task verification hook
# Called by Amp/system after task completion to enforce commit discipline
# 
# This hook ensures:
# 1. All work is committed and pushed (via verify-task-complete)
# 2. Uses cached check results from pre-commit (fast non-blocking)
# 3. DevLoop findings are extracted and filed as Beads issues

set -e

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
PROJECT_ROOT="$(dirname "$(dirname "$SCRIPT_DIR")")"

cd "$PROJECT_ROOT"

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "Post-Task Verification"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Step 1: Basic commit/push verification
if ! .agents/verify-task-complete; then
    echo ""
    echo "âš ï¸  Task verification failed. Please fix the issues above."
    echo ""
    echo "Quick fix steps:"
    echo "  1. git status              # See what needs to be done"
    echo "  2. git add <files>         # Stage changes"
    echo "  3. git commit -m '...'     # Commit with descriptive message"
    echo "  4. git push origin main    # Push changes"
    echo "  5. .agents/verify-task-complete  # Verify again"
    echo ""
    exit 1
fi

echo ""
echo "âœ… Commit & push verification passed"
echo ""

# Step 2: Check cached quality results (non-blocking for Amp tasks)
# These checks already ran in pre-commit hook, so use cached result
echo "[Quality] Checking quality check results..."

CACHE_DIR="$PROJECT_ROOT/.devloop/check-cache"
CACHE_RESULT_FILE="$CACHE_DIR/result.json"

if [ -f "$CACHE_RESULT_FILE" ]; then
    cached_exit_code=$(grep -o '"exit_code": [0-9]*' "$CACHE_RESULT_FILE" | grep -o '[0-9]*')
    cached_timestamp=$(grep -o '"date": "[^"]*"' "$CACHE_RESULT_FILE" | cut -d'"' -f4)
    
    echo "[Quality] Last check results: $cached_timestamp"
    
    if [ "$cached_exit_code" -eq 0 ]; then
        echo "[Quality] âœ… All quality checks passed (cached result)"
    else
        echo ""
        echo "âš ï¸  Some code quality checks failed (non-blocking in post-task)"
        echo "     Consider fixing these issues in your next task:"
        echo "     - Run 'poetry run black src/' for formatting"
        echo "     - Run 'poetry run ruff check src/ --fix' for linting"
        echo "     - Run 'poetry run mypy ...' for type checking"
        echo "     - Run 'poetry run pytest' for tests"
        echo ""
    fi
else
    echo "[Quality] ğŸ“ No cached results (quality checks may not have run)"
fi

# Step 3: Extract DevLoop findings to Beads issues (async background)
echo ""
echo "[Findings] Starting async findings extraction..."

FINDINGS_SCRIPT=".agents/hooks/extract-findings-to-beads"
BG_JOBS_DIR="$PROJECT_ROOT/.devloop/bg-jobs"

if [ -x "$FINDINGS_SCRIPT" ]; then
    # Run findings extraction in background (non-blocking)
    mkdir -p "$BG_JOBS_DIR"
    
    # Spawn in background and capture PID
    "$FINDINGS_SCRIPT" >> "$PROJECT_ROOT/.devloop/findings-extraction.log" 2>&1 &
    BG_PID=$!
    
    # Store PID for monitoring
    echo "$BG_PID" > "$BG_JOBS_DIR/$BG_PID.pid"
    
    echo "[Findings] âœ… Async extraction started (PID: $BG_PID)"
    echo "[Findings]    Findings will be extracted in background"
    echo "[Findings]    Check .devloop/findings-extraction.log for progress"
    
    # Optional: with timeout, wait up to 30s but don't block
    if timeout 30s wait $BG_PID 2>/dev/null; then
        echo "[Findings] âœ… Background extraction completed"
    else
        echo "[Findings] â„¹ï¸  Extraction still running in background"
    fi
else
    echo "[Findings] ğŸ“ Extract-findings script not found (optional)"
fi

# Cleanup stale background jobs
echo "[Cleanup] Removing stale background jobs..."
if [ -x ".agents/cleanup-bg-jobs" ]; then
    .agents/cleanup-bg-jobs 2>/dev/null || true
fi

echo ""
echo "âœ¨ Task verification complete. Ready for next task."
echo ""
exit 0
