#!/usr/bin/env python3
"""
Amp slash command: /agent-summary

Generates intelligent summaries of recent dev-agent findings.
Standalone version with no external dependencies.
"""

import sys
import json
import argparse
from pathlib import Path
from datetime import datetime, timedelta
from typing import Any, Dict, List


def get_repo_root() -> Path:
    """Get the repository root directory."""
    return Path(__file__).parent.parent.parent


def load_context_files(context_dir: Path) -> Dict[str, Any]:
    """Load all context files from the context directory."""
    context = {}
    
    if not context_dir.exists():
        return context
    
    for json_file in context_dir.glob("*.json"):
        try:
            with open(json_file) as f:
                context[json_file.stem] = json.load(f)
        except (json.JSONDecodeError, IOError):
            pass
    
    return context


def format_summary(context: Dict[str, Any], scope: str, filters: Dict[str, str]) -> str:
    """Format the summary as markdown."""
    output = []
    output.append("# Agent Summary")
    output.append("")
    
    output.append(f"**Scope:** {scope}")
    if filters:
        output.append(f"**Filters:** {', '.join(f'{k}={v}' for k, v in filters.items())}")
    output.append("")
    
    # Count actual findings from all categories
    total_findings = 0
    for category in ["immediate", "relevant", "background"]:
        if category in context and isinstance(context[category], dict):
            findings = context[category].get("findings", [])
            if isinstance(findings, list):
                total_findings += len(findings)
    
    output.append(f"**Total Findings:** {total_findings}")
    output.append("")
    
    # Show immediate issues
    if "immediate" in context and context["immediate"]:
        immediate = context["immediate"]
        if isinstance(immediate, dict) and immediate.get("findings"):
            output.append("## üö® Immediate Issues")
            output.append("")
            for finding in immediate.get("findings", [])[:5]:
                if isinstance(finding, dict):
                    agent = finding.get("agent", "unknown")
                    message = finding.get("message", "No message")
                    output.append(f"- **{agent}**: {message}")
            output.append("")
    
    # Show relevant issues
    if "relevant" in context and context["relevant"]:
        relevant = context["relevant"]
        if isinstance(relevant, dict) and relevant.get("findings"):
            output.append("## ‚ö†Ô∏è Relevant Issues")
            output.append("")
            for finding in relevant.get("findings", [])[:5]:
                if isinstance(finding, dict):
                    agent = finding.get("agent", "unknown")
                    message = finding.get("message", "No message")
                    output.append(f"- **{agent}**: {message}")
            output.append("")
    
    # Show background items
    if scope in ("all", "session"):
        if "background" in context and context["background"]:
            background = context["background"]
            if isinstance(background, dict) and background.get("findings"):
                output.append("## ‚ÑπÔ∏è Background Items")
                output.append("")
                for finding in background.get("findings", [])[:3]:
                    if isinstance(finding, dict):
                        agent = finding.get("agent", "unknown")
                        message = finding.get("message", "No message")
                        output.append(f"- **{agent}**: {message}")
                output.append("")
    
    if not output or len(output) <= 3:
        output.append("No findings available for the selected scope and filters.")
    
    return "\n".join(output)


def main():
    """Main entry point for the slash command."""
    repo_root = get_repo_root()
    context_dir = repo_root / ".claude" / "context"
    
    # Parse command line arguments
    parser = argparse.ArgumentParser(description="Generate agent summary")
    parser.add_argument("scope", nargs="?", default="recent",
                       help="Time scope: recent, today, session, all")
    parser.add_argument("--agent", help="Filter by agent name")
    parser.add_argument("--severity", help="Filter by severity")
    parser.add_argument("--category", help="Filter by category")
    
    # Parse known args, ignore unknown ones
    args, unknown = parser.parse_known_args()
    
    try:
        # Load context
        context = load_context_files(context_dir)
        
        # Build filters
        filters = {}
        if args.agent:
            filters["agent"] = args.agent
        if args.severity:
            filters["severity"] = args.severity
        if args.category:
            filters["category"] = args.category
        
        # Generate and print summary
        summary = format_summary(context, args.scope, filters)
        print(summary)
    
    except Exception as e:
        print(f"Error: {e}", file=sys.stderr)
        sys.exit(1)


if __name__ == "__main__":
    main()
