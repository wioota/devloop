#!/usr/bin/env python3
"""
Amp slash command: /agent-summary

Generates intelligent summaries of recent dev-agent findings.
Calls the devloop CLI for full operational health and analytics.
"""

import sys
import subprocess
from pathlib import Path


def get_repo_root() -> Path:
    """Get the repository root directory."""
    return Path(__file__).parent.parent.parent


def main():
    """Main entry point for the slash command."""
    repo_root = get_repo_root()
    
    # Parse scope from command line
    # Usage: /agent-summary [scope] [--agent=X] [--severity=X] [--category=X]
    scope = sys.argv[1] if len(sys.argv) > 1 else "recent"
    
    # Build devloop command with remaining args
    cmd = ["poetry", "run", "devloop", "summary", "agent", scope]
    
    # Pass through any additional arguments
    for arg in sys.argv[2:]:
        if arg.startswith("--"):
            cmd.append(arg)
    
    try:
        # Run devloop summary command
        result = subprocess.run(
            cmd,
            cwd=repo_root,
            capture_output=True,
            text=True,
            timeout=30
        )
        
        if result.returncode == 0:
            print(result.stdout)
        else:
            print(f"Error running devloop summary: {result.stderr}")
            sys.exit(1)
    
    except subprocess.TimeoutExpired:
        print("Error: devloop summary command timed out")
        sys.exit(1)
    except Exception as e:
        print(f"Error: {e}", file=sys.stderr)
        sys.exit(1)


if __name__ == "__main__":
    main()
